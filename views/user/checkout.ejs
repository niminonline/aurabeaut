<%-include("../layout/header.ejs")%> <%if(typeof userData != 'undefined'){%>
    <%-include("../layout/menuUser.ejs")%> <%}else{%>
    <%-include("../layout/menu.ejs")%> <%}%>




    <main class="main">
        <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
            <div class="container">
                <h1 class="page-title">Checkout<span>Shop</span></h1>
            </div><!-- End .container -->
        </div><!-- End .page-header -->
        <nav aria-label="breadcrumb" class="breadcrumb-nav">
            <div class="container">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                    <li class="breadcrumb-item"><a href="#">Shop</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                </ol>
            </div><!-- End .container -->
        </nav><!-- End .breadcrumb-nav -->

        <div class="page-content">
            <div class="checkout">
                <div class="container">
                    <div class="checkout-discount">
                        <!-- <form action="#">
                            <input type="text" class="form-control" required id="checkout-discount-input">
                            <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click here to enter your code</span></label>
                        </form> -->
                    </div><!-- End .checkout-discount -->
                    <!-- <form action="#"> -->
                        <div class="row">
                            <div class="col-lg-9">
                                <h4 >Billing Details</h4><!-- End .checkout-title -->
                                    <!-- <div class="row"> -->
                                        <!-- <div class="table-responsive my-4">
                                            <table class="table table-hover">

                                                <td></td>

                                                    </table>
                                                </div> -->


                                    <!-- </div>End .row -->


                                    
                                    
                                    <h6> Delivery Address</h6>

                                    <a href="/add-address?location=/checkout" class="btn btn-primary my-4">Add Address</a>

                                    <div class="row d-flex justify-content-around">
                                       

                                           
                                                
                                                <%  userData.address.map((item,index)=>{%>
                                                    <div class="card">
                                                        <div class="card card-dashboard">
                                                    <div class="card-body m-4">
                                                        <input type="radio" name="options" id=<%=index%> onchange="handleAddress()" >
                                                        <p>Name : <%=item.name%> </p>
                                                        <p>mobile : <%=item.mobile%></p>
                                                        <p>address : <%=item.address%></p>
                                                        <p>city : <%=item.city%></p>
                                                        <p>state : <%=item.state%></p>
                                                        <p>pin : <%=item.pincode%></p>
                                                        
                                                        



<!-- ==------------------------------Start Modal-------------------------------------- -->



<!-- Button trigger modal -->
<button type="button" class="btn btn-secndary" data-toggle="modal" data-target="#addressBoxModal">
    Edit
  </button>
  
  <!-- Modal -->
  <div class="modal fade" id="addressBoxModal" tabindex="-1" role="dialog" aria-labelledby="addressBoxModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addressBoxModalTitle">Edit address</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
         
            <form action="/update-address" class="form-floating m-4" method="post">

                <input type="text" name="index" value="<%=index%>" hidden>
                <div class="row g-2">
                <div class="form-floating col-md-6">
                <label for="floatingInputValue">Name</label>
                <input type="text" class="form-control" name="name" placeholder="Enter Name" value="<%=item.name%>" required>
             </div>
             <div class="form-floating col-md-6">
                <label for="floatingInputValue">Mobile number</label>
                <input type="text" class="form-control" name="mobile" placeholder="Enter Mobile number" value="<%=item.mobile%>" required>
             </div>
            </div>
        
            <div class="row">
                
                <div class="form-floating col-md-12">
                   <label for="floatingInputValue">Address</label>
                   <input type="text" class="form-control" name="address" placeholder="Enter Address" value="<%=item.address%>" required>
                </div>
                </div>
        
             <div class="row g-2">
                <div class="form-floating col-md-6">
                <label for="floatingInputValue">Pincode</label>
                <input type="text" class="form-control" name="pincode" placeholder="Enter Pincode" value="<%=item.pincode%>" required>
             </div>
             <div class="form-floating col-md-6">
                <label for="floatingInputValue">City</label>
                <input type="text" class="form-control" name="city" placeholder="Enter City" value="<%=item.city%>" required>
             </div>
             </div>
        
             <div class="row g-2">
             <div class="form-floating col-md-6">
             <label for="floatingInputValue">State</label>
             <input type="text" class="form-control" name="state" placeholder="Enter State" value="<%=item.state%>" required>
          </div>
          <div class="form-floating col-md-6">
             <label for="floatingInputValue">Landmark</label>
             <input type="text" class="form-control" name="landmark" placeholder="Enter Landmark" value="<%=item.landmark%>" >
          </div>
          </div>
          
        


         
        </div>
        <div class="modal-footer">
            <input type="submit" value="Save" class="btn btn-primary">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </form>
        </div>
      </div>
    </div>
  </div>








<!-- ==------------------------------End  Modal-------------------------------------- -->






                                                    </div>
                                                </div><!-- End .card-dashboard -->
                                            </div>
                                               <% })%>


                                         
                                    </div>

                                    

                                    <label>Order notes (optional)</label>

                                    <textarea class="form-control" cols="30" rows="4" id="notes" name="notes" placeholder="Notes about your order, e.g. special notes for delivery"></textarea>
                                </div><!-- End .col-lg-9 -->
                            <aside class="col-lg-3">
                                <div class="summary">
                                    <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

                                    <table class="table table-summary">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                 <!-- ----------------------Loop------------------------   -->
                 <%userData.cart.map((item)=>{%>
                                            <tr>
                                                <td> <%=item.product.name%> x <%=item.quantity%> </td>
                                                <td> <%=item.quantity*item.product.price%></td>
                                            </tr>
                                            <%})%>
        <!-- ----------------------Loop------------------------   -->
                                            
                                            <tr class="summary-subtotal">
                                                <td>Subtotal:</td>
                                                <td><%=subTotal%></td>
                                            </tr><!-- End .summary-subtotal -->
                                           
                                            <tr class="summary-total">
                                                <td>Total:</td>
                                                <td id="totalAmount"><%=subTotal%></td>
                                            </tr><!-- End .summary-total -->
                                        </tbody>
                                    </table><!-- End .table table-summary -->

                                    <div class="accordion-summary" id="accordion-payment">
                                       

                                        <!-- End .card -->

                                        <div class="card ">
                                            <div class="card-header" id="heading-3">
                                                <h4>Payment Mode</h4>
                                            <!-- ----------------Payment method------------        -->
                                                   
                                               <div class="paymentItem my-4">
                                              <input type="radio" name="paymentMode" id="cod" value="Cash on Delivery" onchange="paymentMode()"> 
                                              <label for="cod">Cash On Delivery</label>     
                                             </div>
                                             <div class="paymentItem my-4" >
                                                <input type="radio" name="paymentMode" id="creditCard" value="Razorpay"  onchange="paymentMode()"> 
                                                <label for="creditCard">Credit/debit Card</label>     
                                               </div>

                                               <div class="paymentItem my-4">
                                                <input type="radio" name="paymentMode" id="upi" value="UPI" onchange="paymentMode()"> 
                                                <label for="upi">UPI</label>     
                                               </div>
  
                                           
                                                    
                                                
                                            </div><!-- End .card-header -->
                                        </div><!-- End .card -->

                                        <!-- End .card -->



                                        

                                    <button  onclick="checkout()"  class="btn btn-outline-primary-2 btn-order btn-block">
                                        <span class="btn-text">Place Order</span>
                                        <span class="btn-hover-text">Proceed to Checkout</span>
                                    </button>
                                </div><!-- End .summary -->
                            </aside><!-- End .col-lg-3 -->
                        </div><!-- End .row -->
                    <!-- </form> -->
                </div><!-- End .container -->
            </div><!-- End .checkout -->
        </div><!-- End .page-content -->
    </main><!-- End .main -->




    <script>

let addressIndex = null;
let selectedPaymentMode = null;
const totalAmount= document.getElementById("totalAmount").innerText;
const notes= document.getElementById("notes").value;
  
const handleAddress=()=>{
let options = document.getElementsByName('options');
  for (var i = 0; i < options.length; i++) {
    if (options[i].checked) {
      addressIndex = options[i].id;
      break;
    }
  }
}
const paymentMode =()=>{
    let radioButtons = document.getElementsByName('paymentMode');

for (var i = 0; i < radioButtons.length; i++) {
  if (radioButtons[i].checked) {
     selectedPaymentMode = radioButtons[i].value;
  }
}
}


const checkout= ()=>{


if(addressIndex==null){
    new swal("Please select an address");
}
else if(selectedPaymentMode==null){
    new swal("Please select a payment mode");
}
else if(selectedPaymentMode=='Razorpay'){

// =========================Start RazorPay=============//

    fetch("/payment-gateway",{
    method:"POST",
    headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123'
  },
  body:
    JSON.stringify({
        notes:  notes,
        paymentMode: selectedPaymentMode,
        addressIndex:addressIndex,
        totalAmount:totalAmount
  })
}).then(function(response) {
   return response.json();
  })
  .then(function(data) {
   console.log('data',data)
    // const options = {
    //   key: 'rzp_test_9zHydJZu7xq9lh',
    //   amount: data.amount,
    //   currency: 'INR',
    //   name: 'aurabeaut',
    //   description: 'Payment for aurabeaut',
    //   order_id: data.id,
    //   handler: function(response) {
    //     console.log(response);
    //   },
    //   prefill: {
    //     email: 'user@example.com',
    //     contact: '9999999999'
    //   }
    // };
    
    var options = {
    key: 'rzp_test_9zHydJZu7xq9lh', 
    amount: data.amount,
    currency: "INR",
    name: "auraBeaute",
    description: "auraBeaute Payment Gateway",
    image: "/images/aurabeaut-logo.png",
    order_id: data.id,
    callback_url: "/pg-order?order_id="+data.id,
    prefill: {
        name: data.userName,
        email: data.userEmail,
        contact: data.userMobile
    },
    notes: {
        "address": "auraBeaute Kerala"
    },
    theme: {
        "color": "#497004"
    }
};
    const razorpayInstance = new Razorpay(options);
    razorpayInstance.open();
  })
  .catch(function(error) {
    console.error(error);
  });
  placeOrder();
}


// =========================End Start RazorPay=============//
else if(selectedPaymentMode=='Cash on Delivery'){
    placeOrder();

}
}

// =======================Start Place Order======================
const placeOrder=()=>{

fetch("/place-order",{
    method:"POST",
    headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123'
  },
  body:
    JSON.stringify({
        notes:  notes,
        paymentMode: selectedPaymentMode,
        addressIndex:addressIndex,
        totalAmount:totalAmount
  })

}).then(response=>{
    return response.json;
}).then((data)=>{
    fetch("/order-success",{
        method:"GET",
        headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer token123'
  },body:
    JSON.stringify({
        orderData:data
  })})

})
}
// }).then(response => {
//     console.log(response);
//     if (response.statusText=="OK"
// ) {
//     swal("Congrats", "Your order has been placed", "success").then((value) => {
//         window.location.href="/home"
//     })
     
//     } else {
//       console.log('Request failed');
//     }
//   })
//   .catch(error => {
//     console.error('An error occurred:', error);
//   });



// =======================End  Place Order======================
</script>


    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <%-include("../layout/footer.ejs")%>


